#!/usr/bin/env python3

# Copyright (C) 2017, Amazon.com. All Rights Reserved
#
# Basic minimal suite of TF to Inkling tests
#
# Examples
#   Existence test
#     /bin/rm -rf [0-9]* ; ./RunAll --verbose --test 0-1conv0
#   All tests
#     /bin/rm -rf [0-9]* ; ./RunAll --verbose
#

import os, sys
import argparse

kPath = os.environ.get('KAENA_PATH')
kePath = os.environ.get('KAENA_EXT_PATH')
iPath = os.environ.get('INKLING_PATH')
if kPath == None or kePath == None or iPath == None or \
    not os.path.isdir(kPath) or not os.path.isdir(kePath) or not os.path.isdir(iPath):
  print("ERROR: make sure KAENA_PATH, KAENA_EXT_PATH, and INKLING_PATH environment is set");
  exit(1)

parser = argparse.ArgumentParser()
parser.add_argument('--test', help='Run specific tests (list)', nargs='+', default=[])
parser.add_argument('--stop_after', help='Supported: frontend, backend (default)', default="backend")
parser.add_argument('--verbose', help='Verbose output', action='store_true', default=False)

args = parser.parse_args()
verbose = args.verbose

if verbose:
  print("\nINFO: started as  ", " ".join(sys.argv))

# test naming
#   level-name
#   level is relative complexity and runtime cost, easiest 0  to most complex 9
#   Name can be composed of anything - 0 can be used as base/existence test
tests = {
  "0-1conv0"      : [ "trivnet_conv1",  "b1-h1-r1-s1-c1-m1-wmin2-wmax2-imin3-imax3", "1conv"],
  "0-2conv0"      : [ "trivnet_conv2",  "b1-h1-r1-s1-c1-m1-wmin2-wmax3-imin5-imax5", "2conv"],
  "0-neg"         : [ "trivnet_conv2",  "b1-Zh1-r1-s1-c1-m1-wmin2-wmax3-imin5-imax5", "I_ALWAYS_FAIL"],
  "0-1conv_tile"  : [ "trivnet_conv1",  "b1-h35-r3-s1-c1-m1-wmin-0.1-wmax0.1-imin-0.2-imax0.2", "1conv"],
  "0-2conv3_32b"  : [ "trivnet_lin",    "tfloat32-l2-b1-h4-r3-s1-c1-m1-wmin-1000-wmax1000-imin-10000-imax10000", "2conv32b"],
  "0-30conv3"     : [ "trivnet_lin",    "tfloat16-l30-b1-h4-r3-s1-c1-m1-wmin-0.2-wmax0.2-imin-10000-imax10000", "30conv"],
  "0-10conv_relu" : [ "trivnet_lin",    "tfloat16-l10-b1-h4-r3-s1-c1-m1-relu-wmin-0.2-wmax0.4-imin-1000-imax1000", "10cr"],
  "0-116conv_tanh" : [ "trivnet_lin",   "tfloat16-l116-b1-h4-r3-s1-c1-m1-tanh-wmin-0.2-wmax0.8-imin-4-imax8", "116ct"],
  "0-2conv_pad2"  : [ "trivnet_conv1",  "b1-h4-r2-s1-c1-m1-wmin-0.1-wmax0.1-imin-0.2-imax0.2", "2conv_pad2"],
  "0-2conv_pad2as": [ "trivnet_conv1",  "b1-h2-r2-s1-c1-m1-wmin1-wmax4-imin5-imax8", "2conv_pad2as"],
  "0-2conv_pad3"  : [ "trivnet_conv1",  "b1-h4-r3-s1-c1-m1-wmin-0.1-wmax0.1-imin-0.2-imax0.2", "2conv_pad3"],
  "0-2conv_pad5"  : [ "trivnet_conv1",  "b1-h4-r5-s1-c1-m1-wmin-0.1-wmax0.1-imin-0.2-imax0.2", "2conv_pad5"],
  "0-1conv_s2"    : [ "trivnet_conv1",  "b1-h4-r1-s2-c1-m1-wmin-0.1-wmax0.1-imin-0.2-imax0.2", "1conv"],
  "0-1conv_s8"    : [ "trivnet_conv1",  "b1-h16-r1-s8-c1-m1-wmin2-wmax2-imin1-imax256", "1conv"],
  "0-1mp0"        : [ "trivnet_mp1",    "b1-h4-r1-s1-c1-m1-wmin0-wmax0-imin1-imax16", "1mp"],
  "0-1mp0c64"     : [ "trivnet_mp1",    "b1-h4-r1-s1-c64-m64-wmin0-wmax0-imin1-imax1024", "1mp"],
  "0-1mp_r3s2"    : [ "trivnet_mp1",    "b1-h5-r3-s2-c1-m1-wmin0-wmax0-imin1-imax25", "1mp"],
  "0-1mp_r3s2_112_55"  : [ "trivnet_mp1", "b1-h112-r3-s2-c1-m1-wmin0-wmax0-imin1-imax12544", "1mp"],
  "0-1ap0"        : [ "trivnet_ap1",    "b1-h4-r1-s1-c1-m1-wmin0-wmax0-imin1-imax16", "1ap"],
  "0-1ap7x7"      : [ "trivnet_ap1",    "b1-h7-r7-s7-c64-m64-wmin0-wmax0-imin1-imax784", "1ap"],
  "0-1conv_s8_32b": [ "trivnet_lin",    "tfloat32-l2-b1-h16-r1-s8-c1-m1-wmin-0.1-wmax0.1-imin-0.2-imax0.2", "1conv32"],
  "1-1conv7_64"   : [ "trivnet_conv1",  "b1-h16-r7-s1-c64-m64-wmin-0.1-wmax0.1-imin-0.2-imax0.2", "1conv"],
  "1-1conv9_64"   : [ "trivnet_conv1",  "b1-h16-r9-s1-c64-m64-wmin-0.1-wmax0.1-imin-0.2-imax0.2", "1conv"],
  "2-1conv3_64s8" : [ "trivnet_conv1",  "b1-h16-r3-s8-c64-m64-wmin-0.1-wmax0.1-imin-0.2-imax0.2", "1conv"],
  "2-1conv9_64s8" : [ "trivnet_conv1",  "b1-h16-r9-s8-c64-m64-wmin-0.1-wmax0.1-imin-0.2-imax0.2", "1conv"],

  "2-padasym_strd_h3r2s2" : [ "trivnet_conv1", "b1-h3-r2-s2-c1-m1-wmin-0.1-wmax0.1-imin-0.2-imax0.2", "1conv"],
  "2-padasym_strd_h5r2s2" : [ "trivnet_conv1", "b1-h5-r2-s2-c1-m1-wmin-0.1-wmax0.1-imin-0.2-imax0.2", "1conv"],
  "2-padasym_strd_h4r2s3" : [ "trivnet_conv1", "b1-h4-r2-s3-c1-m1-wmin-0.1-wmax0.1-imin-0.2-imax0.2", "1conv"],

  "2-padsym_strd_h3r3s2" : [ "trivnet_conv1", "b1-h3-r3-s2-c1-m1-wmin-0.1-wmax0.1-imin-0.2-imax0.2", "1conv"],
  "2-padsym_strd_h5r3s2" : [ "trivnet_conv1", "b1-h5-r3-s2-c1-m1-wmin-0.1-wmax0.1-imin-0.2-imax0.2", "1conv"],
  "2-padsym_strd_h4r3s3" : [ "trivnet_conv1", "b1-h4-r3-s3-c1-m1-wmin-0.1-wmax0.1-imin-0.2-imax0.2", "1conv"],

  "6-alexnet"     : [ "tf_pb",          "alexnet_v100/alexnet_fp32.pb",  "alexnet", "--input_node Variable --images linspace1"],
  "8-resnet50"                : [ "tf_pb",   "resnet50/resnet_v1_50_fp32_opt.pb",        "resnet50", "--images linspace1 --depth 2"],
  "8-resnet50_fp32_keras"     : [ "tf_pb",   "resnet50_keras/resnet50_fp32_keras.pb",    "resnet50", "--input_node input_1 --images linspace1 --depth 2"],
  "8-resnet50_fp32_keras_opt" : [ "tf_pb",   "resnet50_keras/resnet50_fp32_keras_opt.pb","resnet50", "--input_node input_1 --images linspace1 --depth 2"],
  "8-resnet50_fp16_keras"     : [ "tf_pb",   "resnet50_keras/resnet50_fp16_keras.pb",    "resnet50", "--input_node input_1 --images linspace1 --depth 2"],
  "8-resnet50_fp16_keras_opt" : [ "tf_pb",   "resnet50_keras/resnet50_fp16_keras_opt.pb","resnet50", "--input_node input_1 --images linspace1 --depth 2"],
  "8-resnet152"               : [ "tf_pb",   "resnet_v2_152/pb/resnet_v2_152_fp32.pb",   "resnet152", "--images linspace1 --depth 2"],
}

testList = sorted(tests)
if len(args.test) > 0:
  testList = args.test

for testName in testList:
  # Add default NN args
  if len(tests[testName]) < 4:
    tests[testName].append("")
  (nnStruct, nnConfig, nnLabel, nnArgs) = tests[testName]
  if verbose:
    print("\n############## %s ##############" % testName)
  cmd = 'mkdir %s && cd %s && make -f $KAENA_PATH/compiler/tffe/test/Makefile %s NN_CONFIG=%s OUT_PREFIX=%s_ NN_NAME=%s NN_ARGS="%s" > log-fe.txt 2>&1 && test -f *.tgz && ' % (testName, testName, nnStruct, nnConfig, "trivnet", nnLabel, nnArgs)
  if args.stop_after == "backend":
    cmd += 'bash $KAENA_PATH/compiler/be/test/RunOne.sh *tgz > log-be.txt 2>&1 && '
  cmd += 'echo -n PASS || echo -n FAIL; echo "  "' + testName
  if verbose:
    print("Executing ", cmd)
  os.system(cmd)
  
