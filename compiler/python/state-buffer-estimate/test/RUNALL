fn Error { echo >[1=2] $* }
fn Fatal { Error $*; exit 1 }

fn RunCmd  {
   #sleep 3
   echo $*
   $*
}

##############################################################
switch ($#*) {
case 0
    Fatal Usage $0 NUMBER
}
N=$1

##############################################################

NET=trivnet

CPP=$NET.cpp
OBJ=$NET.obj
EXE=$NET-exe

RESULTS=./results/$N
rm -fR $RESULTS; mkdir $RESULTS

ASM=$RESULTS/$NET.asm
TPB=$RESULTS/$NET.tpb

SIMRES=$RESULTS/$NET.simres
SIMLOG=$RESULTS/simulation.log
LOG=$RESULTS/LOG

##############################################################
TOP=$HOME/kaena/GitFarm/Kaena/compiler/python/state-buffer-estimate
TEST=$TOP/test
##############################################################
##############################################################
{

cd  $TOP
TopCleanFiles=( $CPP $OBJ )
RunCmd rm -f $TopCleanFiles

RunCmd make $NET || Fatal Failed to make $NET
shasum $CPP

cd  $TOP/test
#BottomCleanFiles=($OBJ $EXE $TPB  $ASM $RESULTS/*-out.npy $SIMLOG $SIMRES $RESULTS/*.txt)
RunCmd make $EXE || Fatal Failed make $EXE
RunCmd ./$EXE $TPB || Fatal Failed $EXE $TPB

RunCmd ./objdump $TPB > $ASM || Fatal Failed to create $ASM

RunCmd shasum $TPB
echo ./sim $TPB
./sim $TPB >$SIMRES || Fatal Fail sim $TPB
Files=(
    golden
    $NET-out
)
FMTS = (    
    # int16
    float16
)

for (fmt in $FMTS) {
    for (file in $Files) {
        npy=$file.npy
        txt=$RESULTS/$file-$fmt.txt
        echo dumpnpy --$fmt $npy '>' $txt
        dumpnpy --$fmt $npy > $txt
        shasum  $txt
        cat $txt
    }
}

#echo GOLDEN:
#cat goldn-float16.txt
#echo FROM SIM:
#cat $NET-out-float16.txt
} >[2=1] | tee $LOG
