
pipeline{

    agent {
        dockerfile {
            dir 'test/jenkins'
            customWorkspace './docker-shared'
            args '-u root -v /home/jenkins:/home/jenkins -v /home/jenkins/kaena/.aws:/root/.aws -v $WORKSPACE:/artifact -v /proj/trench/sw/kaena-test:/kaena-test'
            label "${env.AGENT_LABEL}"
        }
    }

    environment {
        AGENT_LABEL = "kaena_c5.18xl"
        SRC_DIR = "/workdir/src"
        BLD_DIR = "$SRC_DIR/build"
        TEST_DIR = "/workdir/test"

        KAENA_PATH = "$SRC_DIR/kcc"
        KAENA_EXT_PATH = "$SRC_DIR/ext"
        INKLING_PATH = "$SRC_DIR/inkling"
        QEMU_INKLING_PATH = "$SRC_DIR/qemu_inkling"
        ARCH_ISA_PATH = "$SRC_DIR/arch-isa"
        KAENA_RT_PATH = "$SRC_DIR/krt"
        ARCH_HEADERS_PATH = "$SRC_DIR/arch-headers"
        ARCH_ARTIFACTS_PATH = "$SRC_DIR/arch-headers"

        KRT_BLD_DIR = "$BLD_DIR/krt"
        KRT_DV_BLD_DIR = "$BLD_DIR/krt_dv"
        KRT_EMU_BLD_DIR = "$BLD_DIR/krt_emu"
        KCC_BLD_DIR = "$BLD_DIR/kcc"
        QEMU_BLD_DIR = "$BLD_DIR/qemu"
        KAENA_BLD_DIR = "$BLD_DIR/kaena"
    }

    stages {
        stage('Prep'){
            steps {
                sh 'cat /etc/os-release'
                sh 'cat /proc/cpuinfo'
                sh 'cat /proc/meminfo'
                sh 'df -h'
                sh 'ls -ltrA'


                sh 'rm -rf $SRC_DIR && mkdir -p $SRC_DIR'
                sh 'rm -rf $BLD_DIR && mkdir -p $BLD_DIR'
                sh 'rm -rf $TEST_DIR && mkdir -p $TEST_DIR/RunAllWithArgs && mkdir -p $TEST_DIR/precheckin && mkdir -p $TEST_DIR/RunPytest && mkdir -p $TEST_DIR/RunToolsPytest && mkdir -p $TEST_DIR/prep_qemu && mkdir -p $TEST_DIR/test_inst_sweep'
                sh '''
                [ -f "/kaena-test/ubuntu-18.04-24G_pytest.qcow2" ] && /bin/cp "/kaena-test/ubuntu-18.04-24G_pytest.qcow2" /tmp/ubuntu-18.04-24G_pytest.qcow2
                '''
            }
        }
        stage('Checkout'){

            steps {
                sh '''
                set -x

                cd $SRC_DIR
                ls -ltrA

                repo init -u ssh://siopt.review/tonga/sw/kaena/manifest
                [ ! -z "$MANIFEST_FILE_NAME" ] || export MANIFEST_FILE_NAME=default.xml
                export MANIFEST_REPO_REFSPEC=$GERRIT_REFSPEC
                git clone  ssh://siopt.review/tonga/sw/kaena/manifest
                git -C manifest fetch origin $GERRIT_REFSPEC || export MANIFEST_REPO_REFSPEC=""
                [ -z "$MANIFEST_REPO_REFSPEC" ] || export MANIFEST_REPO_REFSPEC_OPT="-b $MANIFEST_REPO_REFSPEC"
                repo init -m $MANIFEST_FILE_NAME $MANIFEST_REPO_REFSPEC_OPT
                repo sync -j 8

                git config --global user.name "Jenkins"
                git config --global user.email aws-tonga-kaena@amazon.com

                [ -z "$GERRIT_REFSPEC" ] || \
                git -C krt pull origin $GERRIT_REFSPEC || \
                git -C kcc pull origin $GERRIT_REFSPEC || \
                git -C ext pull origin $GERRIT_REFSPEC || \
                git -C inkling pull origin $GERRIT_REFSPEC || \
                git -C qemu_inkling pull origin $GERRIT_REFSPEC || \
                git -C arch-isa pull origin $GERRIT_REFSPEC || \
                git -C shared pull origin $GERRIT_REFSPEC || \
                git -C manifest pull origin $GERRIT_REFSPEC

                git -C krt  describe --always --dirty 
                git -C kcc  describe --always --dirty 
                git -C ext  describe --always --dirty 
                git -C inkling describe --always --dirty 
                git -C qemu_inkling describe --always --dirty 
                git -C arch-isa describe --always --dirty 
                git -C shared  describe --always --dirty 
                git -C manifest describe --always --dirty 


                chmod -R 755 ./
                ls -ltrA
                '''
            }
        }
        stage('build') {
            stages {
                stage('kaena') {
                    steps {
                        sh 'cd $SRC_DIR/shared && ./build.sh'
                        sh '[ -z "$SIM_DEBUG" ] || (cd $INKLING_PATH/sim && make clean && make opt)'
                    }
                    post {
                        success {
                            sh 'cp $KRT_BLD_DIR/krt-*.*.tar.gz /artifact/'
                            sh 'cp $KRT_DV_BLD_DIR/krt-*.*.tar.gz /artifact/'
                            sh 'cp $KRT_EMU_BLD_DIR/krt-*.*.tar.gz /artifact/'
                            archiveArtifacts artifacts:'krt-*.*.tar.gz'

                            sh 'for f in `ls $KAENA_BLD_DIR/*.tar.gz`; do aws s3 --profile kaena cp $f s3://kaena-release-bucket/$BUILD_TAG/; done'
                            sh 'aws s3 --profile kaena ls --recursive --human-readable s3://kaena-release-bucket/$BUILD_TAG/ > /artifact/files_uploaded.txt'
                            archiveArtifacts artifacts:'files_uploaded.txt'
                        }
                    }
                }
            }
        }
        stage('prep_qemu') {
            steps {
                sh '''
                (cd $TEST_DIR/prep_qemu && $KAENA_PATH/runtime/util/qemu_rt --pool $QEMU_POOL --action start_pool > log_pool.txt 2>&1 &)
                '''
                timeout(time: 30, unit: 'MINUTES') {
                    sh '''
                    (cd $TEST_DIR/prep_qemu && while [ ! -f poolpid.txt ]; do tail log_pool.txt && sleep 1; done; )
                    '''
                }
            }
            post {
                always {
                    sh 'mkdir /artifact/prep_qemu'
                    sh 'find $TEST_DIR/prep_qemu -iname "*.txt" -print0 | tar -czvf /artifact/prep_qemu/logs.tgz -T -'
                    sh 'chmod -R a+wX /artifact/'
                    archiveArtifacts artifacts:'prep_qemu/logs.tgz'
                }
            }
        }
        stage('Regressions') {
            stages {
                stage('check') {
                    steps {
                        timeout(time: 70, unit: 'MINUTES') {
                            sh 'cd $TEST_DIR/precheckin && make -f $KAENA_PATH/test/e2e/Makefile check'
                        }
                    }
                    post {
                        always {
                            catchError {
			    sh '''
			    ([ -f $TEST_DIR/precheckin/RunAllReport.xml ] && /bin/cp $TEST_DIR/precheckin/RunAllReport.xml $WORKSPACE/RunAllReportCheck.xml)
			    '''
			    junit allowEmptyResults: true, testResults: 'RunAllReportCheck.xml'
                            }
                            sh 'find $TEST_DIR/precheckin -type f -name "*.vdi" -delete'
                            sh '/bin/cp -r $TEST_DIR/precheckin /artifact/precheckin'
                            archiveArtifacts artifacts:'precheckin/*.txt,*.tgz, precheckin/**/*.txt,tgz, precheckin/**/*.json, precheckin/**/*.bin, precheckin/**/*.svg, precheckin/**/*.png, precheckin/**/*.csv, precheckin/**/*.asm, precheckin/**/*.npy'
                        }
                        failure {
                            sh 'tar -czvf /artifact/test-precheckin-result-all.tgz $TEST_DIR/precheckin'
                            archiveArtifacts artifacts:'*.tgz'
                        }
                    }
                }
                stage('RunAllWithArgs') {
                    steps {
                        timeout(time: 12, unit: 'HOURS') {
                            sh '''
                            [ -z "$RUNALL_ARGS" ] || (cd $TEST_DIR/RunAllWithArgs && $KAENA_PATH/test/e2e/RunAll $RUNALL_ARGS)
                            '''
                        }
                    }
                    post {
                        always {
                            catchError {
		            sh '''
			    [ -z "$RUNALL_ARGS" ] || ([ -f $TEST_DIR/RunAllWithArgs/RunAllReport.xml ] && /bin/cp $TEST_DIR/RunAllWithArgs/RunAllReport.xml $WORKSPACE/RunAllReportFull.xml)
			    '''
			    junit allowEmptyResults: true, testResults: 'RunAllReportFull.xml'
                            }
                            sh 'mkdir /artifact/RunAllWithArgs'
                            sh '/bin/cp $TEST_DIR/RunAllWithArgs/qor* /artifact/RunAllWithArgs/ || touch /artifact/RunAllWithArgs/qor_RunAllWithArgs_qor_available.txt'
                            sh 'for f in `find $TEST_DIR/RunAllWithArgs  -iname "*.txt" -o -iname "*.json" -o -iname "*.bin" -o -iname "*.svg" -o -iname "*.png" -o -iname "*.csv" -o -iname "*.asm" -o -iname "kelf.tar.gz"`; do cp $f --parents  /artifact/RunAllWithArgs/;done; '
                            sh 'for f in `find $TEST_DIR/RunAllWithArgs/*/working_dir  -iname "*.npy" -a -type f`; do cp $f --parents  /artifact/RunAllWithArgs/;done; '
                            sh 'chmod -R a+wX /artifact/'
                            archiveArtifacts artifacts:'RunAllWithArgs/*.txt,*.tgz,RunAllWithArgs/**/*.txt,tgz,RunAllWithArgs/**/*.json, RunAllWithArgs/**/*.bin, RunAllWithArgs/**/*.svg, RunAllWithArgs/**/*.png, RunAllWithArgs/**/*.csv, RunAllWithArgs/**/*.asm, RunAllWithArgs/**/*.npy, RunAllWithArgs/**/kelf.tar.gz'
                        }
                        failure {
                            sh 'find $TEST_DIR/RunAllWithArgs -type f -name "*.vdi" -delete'
                            sh 'find $TEST_DIR/RunAllWithArgs -iname "*.txt" -print0 | tar -czvf /artifact/RunAllWithArgs/logs.tgz -T -'
                            sh 'chmod -R a+wX /artifact/'
                            archiveArtifacts artifacts:'RunAllWithArgs/logs.tgz'
                        }
                    }
                }
                stage('RunPytest') {
                    steps {
                        timeout(time: 50, unit: 'MINUTES') {
                            sh '''
                            [ -z "$RUNNC_ARGS" ] || (cd $TEST_DIR/RunPytest && $KAENA_PATH/runtime/util/qemu_rt $RUNNC_ARGS)
                            '''
                        }
                    }
                    post {
                        always {
                            catchError {
			    sh '''
			    [ -z "$RUNNC_ARGS" ] || ([ -f $TEST_DIR/RunPytest/pytestResult.xml ] && /bin/cp $TEST_DIR/RunPytest/pytestResult.xml $WORKSPACE/.)
			    '''
			    junit allowEmptyResults: true, testResults: 'pytestResult.xml'
                            }
                            sh 'mkdir /artifact/RunPytest'
                            sh 'find $TEST_DIR/RunPytest -iname "*.txt" -print0 | tar -czvf /artifact/RunPytest/logs.tgz -T -'
                            sh 'chmod -R a+wX /artifact/'
                            archiveArtifacts artifacts:'RunPytest/logs.tgz'
                        }
                        failure {
                            sh 'find $TEST_DIR/RunPytest -type f -name "*.vdi" -delete'
                        }
                    }
                }
                stage('RunToolsPytest') {
                    steps {
                        timeout(time: 50, unit: 'MINUTES') {
                            sh '''
                            cd $TEST_DIR/RunToolsPytest
                            tar xvf $KRT_BLD_DIR/krt-*.*-*-core.tar.gz
                            PYTHONPATH=$PYTHONPATH:./bin pytest $KAENA_RT_PATH/tools/kasm/tests --junitxml=pytestResult.xml -s > log-pytest.txt 2>&1
                            '''
                        }
                    }
                    post {
                        always {
                            catchError {
                            sh '''
                            [ -f $TEST_DIR/RunToolsPytest/pytestResult.xml ] && /bin/cp $TEST_DIR/RunToolsPytest/pytestResult.xml $WORKSPACE/.
                            '''
                            junit allowEmptyResults: true, testResults: 'pytestResult.xml'
                            }
                            sh 'mkdir /artifact/RunToolsPytest'
                            sh 'find $TEST_DIR/RunToolsPytest -iname "*.txt" -print0 | tar -czvf /artifact/RunToolsPytest/logs.tgz -T -'
                            sh 'chmod -R a+wX /artifact/'
                            archiveArtifacts artifacts:'RunToolsPytest/logs.tgz'
                        }
                    }
                }
                stage('inst-sweep test') {
                    steps {
                        catchError {
                            sh '''
                            cd $TEST_DIR/test_inst_sweep && export KRT_INST_SWEEP_TEST_DIR=$KRT_BLD_DIR/tests/inst-sweep/ && export KRT_INST_SWEEP_OUTPUT_DIR=$TEST_DIR/test_inst_sweep && export KAENA_QEMU_POOL=$QEMU_POOL && pytest $KAENA_RT_PATH/tests/inst-sweep/inst-sweep.py --junitxml=pytestResult.xml -k "Softmax or QuantMatmul8DR or ActLeaky or PseudoDmaMemcpy" 2>&1 | tee log-pytest.txt
                            '''
                        }
                    }
                    post {
                        always {
                            catchError {
                               sh '''
                               [ -f $TEST_DIR/test_inst_sweep/pytestResult.xml ] && /bin/cp $TEST_DIR/test_inst_sweep/pytestResult.xml $WORKSPACE/.
                               '''
                               junit allowEmptyResults: true, testResults: 'pytestResult.xml'
                               sh 'mkdir /artifact/test_inst_sweep'
                               sh 'find $TEST_DIR/test_inst_sweep -print0 | tar -czvf /artifact/test_inst_sweep/logs.tgz -T -'
                               sh 'chmod -R a+wX /artifact/'
                               archiveArtifacts artifacts:'test_inst_sweep/logs.tgz'
                            }
                        }
                        failure {
                            catchError {
                                sh 'find $TEST_DIR/test_inst_sweep -type f -name "*.vdi" -delete'
                            }
                        }
                    }
                }
            }
        }
    }
    post {
        failure {
            script {
                 if (!env.GERRIT_REFSPEC) { 
                     // Send an email only if the build status has changed from green/unstable to red
                     emailext subject: '$DEFAULT_SUBJECT',
                     body: '''${SCRIPT, template="groovy-html-change.template"}''',
                     recipientProviders: [
                             [$class: 'CulpritsRecipientProvider'],
                             [$class: 'DevelopersRecipientProvider'],
                             [$class: 'RequesterRecipientProvider']
                     ],
                       replyTo: '$DEFAULT_REPLYTO',
                     to: 'aws-tonga-kaena@amazon.com'
                 }
            }
        }
        always {
            sh 'df -h'
            sh 'cat /proc/meminfo'
            sh 'ls -ltrA'
            cleanWs()
        }
    }
}

